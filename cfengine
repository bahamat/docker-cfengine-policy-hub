#/bin/bash

set -o xtrace

if [ -z "${WITH_MASTERFILES}" ]; then
    sed -i "/services_autorun/ s/!any/any/" /var/cfengine/masterfiles/def.cf
fi

cf-key
cf-agent -B $(hostname --ip-address)

if [ -z "${WITH_TESTFILES}" ]; then
    cf-agent -KI
    pkill cf-serverd
    pkill cf-execd

    /var/cfengine/bin/cf-execd --no-fork ${CF_FLAGS} &
    exec /var/cfengine/bin/cf-serverd --no-fork ${CF_FLAGS}
else
    cf-agent -KI -f "${WITH_TESTFILES}/promises.cf"
fi
